name: Cleanup of Stale Branches (with Dry Run)

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Perform a dry run without deleting branches (true/false)'
        required: true
        default: 'true'
  push:
    branches:
      - feature/first-branch-deletion-test # Trigger on push to this specific branch
  pull_request:
    branches:
      - feature/first-branch-deletion-test  # Trigger on pull request to this specific branch

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup GitHub CLI
        run: |
          gh auth setup-git
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete or Log stale branches and associated PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          git fetch --prune
          branches=$(git branch -r | grep -v "^\* main$" | grep -v main | sed 's/origin\///')
          for branch in $branches; do
            # Skip branches with 'long-term' in their name
            if [[ "$branch" =~ long-term ]]; then
              echo "Skipping pruning for long-term branch: $branch"
              continue
            fi
           
            # Check pull requests first
            prs=$(gh pr list --state open --base $branch --json updatedAt,number,title)
            # Determine action based on pull request activity
            if [ -z "$prs" ] || echo $prs | jq -c '.[] | select(.updatedAt | fromdateiso8601 < (now - 7776000))'; then
              # Check if branch has had no commits in the last 3 months
              if [[ $(git log -1 --since="3 months ago" -s origin/$branch) == "" ]]; then
                echo "Would delete $branch due to inactivity"
              fi
            fi
          done
