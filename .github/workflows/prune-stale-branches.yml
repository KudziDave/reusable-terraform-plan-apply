name: Cleanup of Stale Branches (Deletes if branch and commits are 2+ months old)

on:
  push:
    branches:
      - feature-final-branch  # üîÅ Replace with the branch you want to trigger on

permissions:
  contents: write
  pull-requests: write

jobs:
  cleanup:
    name: Cleanup Stale Branches in Multiple Repos
    runs-on: ubuntu-latest

    steps:
      - name: Ensure CLI tools are installed
        run: |
          command -v gh >/dev/null || (echo "‚ùå GitHub CLI (gh) is not installed" && exit 1)
          command -v jq >/dev/null || (echo "‚ùå jq is not installed" && exit 1)

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Cleanup stale branches across repositories (Dry Run with Debug)
        run: |
          set -eo pipefail
          set -x  # Show each command before execution
          trap '' PIPE

          repos=(
            "KudziDave/reusable-terraform-plan-apply"
            # Add more repositories here
          )

          for repo in "${repos[@]}"; do
            echo ""
            echo "üîÅ Processing $repo"
            echo "============================================="

            {
              # Fetch all branches
              branches=$(gh api repos/$repo/branches --jq '.[].name')

              for branch in $branches; do
                if [[ "$branch" == "main" ]]; then
                  echo "‚è≠Ô∏è Skipping 'main'"
                  continue
                fi

                # Check branch protection
                allow_delete=$(gh api repos/$repo/branches/$branch/protection --silent 2>/dev/null | jq -r '.allow_deletions.enabled // "true"')
                if [[ "$allow_delete" == "false" ]]; then
                  echo "‚è≠Ô∏è Skipping protected branch: $branch"
                  continue
                fi

                # Check do-not-prune tag
                if gh api repos/$repo/git/ref/tags/do-not-prune/$branch --silent >/dev/null 2>&1; then
                  echo "üè∑Ô∏è Skipping tagged branch: do-not-prune/$branch"
                  continue
                fi

                # Get last commit date
                last_commit_date=$(gh api repos/$repo/commits/$branch --jq '.commit.committer.date' || echo "")
                last_commit_timestamp=$(date -d "$last_commit_date" +%s 2>/dev/null || echo 0)
                two_months_ago_timestamp=$(date -d "2 months ago" +%s)

                if [[ "$last_commit_timestamp" -eq 0 || "$last_commit_timestamp" -ge "$two_months_ago_timestamp" ]]; then
                  echo "‚úÖ Branch '$branch' is active or too recent."
                  continue
                fi

                # Get branch creation date (based on first unique commit)
                merge_base=$(gh api repos/$repo/compare/main...$branch --jq '.merge_base_commit.sha' || true)
                first_commit=$(gh api repos/$repo/commits/$branch --jq '.[].sha' --paginate | tail -n 1)
                if [[ -n "$first_commit" ]]; then
                  branch_creation_date=$(gh api repos/$repo/commits/$first_commit --jq '.commit.committer.date')
                  branch_creation_timestamp=$(date -d "$branch_creation_date" +%s)
                else
                  echo "‚è≠Ô∏è No unique commits found for $branch. Skipping."
                  continue
                fi

                if [[ "$branch_creation_timestamp" -ge "$two_months_ago_timestamp" ]]; then
                  echo "‚è≠Ô∏è Branch '$branch' is too new."
                  continue
                fi

                echo "üî• Deleting stale branch: $branch"
                echo "  ‚û§ Last commit: $last_commit_date"
                echo "  ‚û§ Created on: $branch_creation_date"
                echo "  ‚û§ (Dry run) Would delete branch: $branch"
                # Dry run: don't actually delete
                # if ! gh api -X DELETE repos/$repo/git/refs/heads/$branch; then
                #   echo "‚ö†Ô∏è Failed to delete branch '$branch'. It may be protected."
                # fi
              done

            } || {
              echo "‚ùå Failed to process $repo ‚Äî skipping to next."
              continue
            }
          done
